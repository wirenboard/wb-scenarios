# Руководство по модулю топик менеджера (topicmgr)

## Общее описание

Данный модуль помогает создать регистр топиков с которыми вам нужно работать
и хранить данные относящиеся к топикам централизованно на протяжении работы
вашего правила wb-rules. Под данными понимается любая информация, флаги,
состояния, таблицы и тд - то есть что может быть необходимо в работе.
Например при подключении расширения event можно хранить для каждого из
топиков обработчики конкретных событий, типа whenEnabled, whenDisabled и тд.

Структура решения поддерживает расширения и состоит из нескольких файлов:
- topicmgr-main.js - базовый модуль который содержить только базовый объект
- topicmgr-event-main.js - расширение для событий
- topicmgr-event-resolvers.js - резолверы для событий
- topicmgr-history-main.js - расширение для истории событий


## Структура регистра топиков

На данный момент реализована работат только событий. Ниже иллюстрация
структуры - того как должен выглядеть объект при добавлении других модулей.

![Структура регистра топиков](topic-registry-structure.png)

Внутри объекта возвращаемого createTopicManager() содержится две сущности
1) Регистр топиков - который хранит всю информацию которая связана с топиками
2) Глобальные методы обработки данных топиков - например после инициализации
   расширения для работы с событиями появляются методы регистрации собития по
   его имени - `eventMgr.registerSingleEvent()`

Новые методы для работы с топиками должны добавляться именно в корень объекта
это позволяет намного проще реализовывать расширения топик менеджера и не
обходить все дочерние объекты в случае добавления новых методов к ним.

Планы:
1) Реализовать расширение для  настраиваемой истории значений каждого топика,
   что позволит делать более сложные события, анализ данных или цифровые
   фильтры.

## Плагины

Так как кроме событий и истории значений для реализации сложных действий
может потребоваться хранить другие данные в регистре топиков или захочется
добавить новые методы работы с топиками, то реализована система плагинов
которые можно подключать при необходимости и писать свои плагины дополняя
возможности Topic Manager.

Система плагинов выбрана и реализована похожей на vue js.
Плагины подключаются к уже созданному экземпляру топик менеджера и добавляют
в этот объект новые методы, модифицируют или заменяют существующие.

Пример подключения

```
// 1. Подключаем базовый модуль и расширения
var topicmgrMain = require("./topicmgr-main.mod");
var topicmgrEvent = require("./topicmgr-event-main.mod");

// 2. Создаём инстанс topicManager
var topicMgr = topicmgrMain.createTopicManager();

// 3. Добавляем расширения
topicMgr.installPlugin(topicmgrEvent);  // подключаем event-функции
```

Каждый плагин должен иметь
- реализованную функцию install - которая вызовется при установке плагина
- поле с именем плагина - используется для вывода ошибок и др лога

### Гибкая цепочка процессоров

Плагин может быть написан двумя способами
- Добавлять абстрактные методы и поля в реестр которые пользователь использует
  самостоятельно там где ему нужно. Например кастомный логгер.
- Так же может иметь обработчик который будет вставлен в общий обработчик
  обновлений топиков. Например для подсчета статистик постоянной работы.

Общий обработчик - это одна фунция в базовом объекте созданный так чтобы
плагины могли добавлять в нее свои элементы обработки в определенном порядке.

в нашей системе мы знаем только имя топика и новое значение
в базовом элементе должна быть какая то функция которая будет вызываться когда приходит новое значение какого то топика - и вот в этой функции должна быть какая то обработка всех плагинов - например если человек уже написал код раньше и появился новый плагин какой то статистики - например колличество обновлений топика - то он просто включает плагин и вызываемый обработчик в том месте где его вставил пользователь сам меняется и дополняется логикой плагина

В итоге каждый плагин может добавлять новые процессоры которые будут вызваны при обработке новых значений

#### Приоритеты процессоров

Каждый плагин добавляя новый процессор должен указать приоретет в котором он
должен выполниться.

Это важно как для быстродействия, так и для порядка выполнения логики плагинов
ведь один плагин, например обработчик событий должен быть вызван после других
плагинов информацию которых он может использовать, например после плагина
сохранения информации в историю значений топика. А статистика может иметь
необходимость вызванной после обработки событий.



### Два варианта использования

1. Ручное управление обработкой вставляя там где нужно в правила wb-rules
2. Автоматическое создание правила из добавленных в реестр топиков - создает
   одно правило для всех топиков и обрабатывает их плагинами. В этом случае
   правило wb-rules создается топик менеджером и пользователь не должен думать
   об этом. Этот вариант преоритетен если вы не знаете что хотите.