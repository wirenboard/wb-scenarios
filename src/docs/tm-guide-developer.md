# Руководство по разработке для топик менеджера (tm, topic manager)

## Работа с правилами

### 1. Общий принцип

Есть два метода взаимодействия с TM - автоматический и ручной.
Основным методом взаимодействия является автоматический, в котором
все действия пользователя взаимодействующего с wb-rules должны
проксироваться через TM. В этом случае последовательность работы такая.

1. Есть две главных типа сущности которые сохраняют информацию
   - Один реестр всех топиков с которыми идет работа в скрипте
   - Два реестра правил - общий и сервисный
     Все правила которые созданы в скрипте должны быть добавлены либо в однин
     либо во второй реестр.
2. Пользователь сначала конфигурирует то чего хочет делать, например
   регистрирует события - что приводит к добавлению топиков в реестр топиков.
3. После конфигурирования вызывается `tm.initRulesForAllTopics('RuleName');`
   Этот метод создает одно правило в общий реестр и одно правило
   в сервисный реестр.
   - Каждое из правил вызывается при изменении любого из топиков в TM
   - При вызове правило вызывает запуск цепочки процессоров куда добавляют
     свои процессоры плагины.

   Функия в правилах выглядит следующим образом:

   ```javascript
   function (newValue, devName, cellName) {
     var topic = devName + '/' + cellName;
     this.runProcessors(topic, newValue);
   }
   ```

4. Внутри цепочки процессоров последовательно вызываются все процессоры
   которые были добавлены туда плагинами в соответствии с приоритетами.

   Порядок вызова сервисного или обычного реестра правил не гарантируется
   так как для этого нет инструментов в wb-rules.

Таким образом - после вызова `initRulesForAllTopics` в независимости от
используемого колличества топиков или установленных плагинов, в простом
случае всегда создается всего два правила, а вся обработка идет уже внутри
этих двух правил.

Сервисный реестр правил нужно использовать только по необходимости,
вынося туда только обработку сервисных функций - например события
переключателя для управления исполнением правил в винтуальном
устройстве TM вынесено в сервисный реестр из за того что оно должно
продолжить работать после отключения всех правил, иначе потом будет
невозможно включить пользовательские правила обратно.

### 2. Инструменты

Внутренний метод `_defineTmRule()` позволяет определять правило wb-rules
и возвращает объект описывающий правило. Данный объект далее может быть
записан в один из двух реестров.

Есть два метода которые нужно использовать как внутри TM так и снаружи для
добавления правил в один из реестров:

- `_defineAndStoreTmRule()` -> внешне называется `tm.defineRule()`
- `_defineAndStoreServiceTmRule()` -> внешне `tm.defineServiceRule()`

При использовании `initRulesForAllTopics(ruleName)` внутри каждого реестра
создается правило для обработки цепочки обработки данных которые вызываются
при изменении любого из зарегистрированных в TM топиков.

Плагины могут добавлять свои обработчики как один так и во второй
обработчики. Например плагин базового виртуального девайса добавляет
правило в сервисный обработчик для обработки изменения состояния
переключателя разрешения обработки правил пользователя.
