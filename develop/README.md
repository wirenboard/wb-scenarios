# Документация для разработчиков

В данном файле описано все что нужно знать для разработки новых сценариев для WB с нуля.

## Общее о сценариях

Сценарии являются методом упрощения конфигурирования контроллера WB.
Они позволяют настраивать работу частых юзкейсов через графический интерфейс без необходимости изучения написания скриптов

Сценарии состоят из 4 составляющих

1. Описание WEBUI в виде схемы json-editor: `*.schema.json`
При необходимости изображения `*.png`

2. Сохраненный конфиг из вебки в виде json структуры: `*.conf`

3. Файл правил `*.js`
Это точка входа в логику исполнения сценариев, он содержит:

- Чтение конфигурации из файла
- Логику парсинга и подготовки данных для инициализации (если она нужна)
- Вызов методов которые инициализируют виртуальные устрйоства и правила

4. Модуль `*.mod.js`
Это опциональная единица для удобного использования
Сюда можно перенести методы init и другую логику, чтобы их было удобно использовать в том числе из скриптов.

Ниже описывается процесс создания новых сценариев

## Добавление нового сценария
Для добавления нового сценария нужно выполнить несколько шагов:
1) Создать в папке `scenarios` подпапку с именем вашего сценария.
Имя маленькими латинскими буквами через тире, например `link-in-to-out`
Тут хранятся файлы относяшиеся к конкретному сценарию:
- Модуль js `*.mod.js`
- Скрипт `init-*.js` читающий конфиг и инициализирующий сценарий вашего типа на его основе.
- Ридми для данного сценария `README.md` - здесь должен быть внешний вид и краткая инструкция по использованию
2) Добавить описание схемы webui для вашего нового сценария в файл `schema/scenarios.schema.json`
3) Файлы изображений для отображения схеме в формате png - положить рядом в папке `schema/*.png`
4) Если требуется поменять конфиг `wb-scenarios.conf` чтобы он корректно открывался в соответствии с вашими изменениями в схеме.
   В данный момент конфиг поставляется пустым, поэтому этот пункт можно опустить.

## Процесс разработки сценария
1. Пуш первой версии
   1. Создать папку
   2. Создать ридми где описать общий смысл сценария
   3. Создать файл скрипта с шаблоном
   4. Запушить как первую пустую версию

Дальше есть несколько возможных подходов - выберете удобный вам, они в итоге
приводят к одному результату, но разные начальные точки и разные первые PR.

Разделил все три варианта от самого легкого новичкам к более трудным внизу.

### От обычного скрипта

Удобно использовать новичкам в первый раз - когда не знаешь еше окружения и не работал с json-editor.
Путь начинается от обычного скрипта wb-rules и заканчивается интеграцией решения в json-editor

2. Написание обычного скрипта
  На данном этапе нужно написать скрипт который статично выполнит то что вы хотите сделать без обработок ошибок - просто в лоб.

3. ...

### От модуля

Самый сложный и абстрактный путь самурая которому не нужны никакая опора под ногами для работы.
Модуль сам по себе является опциональной единицей разделения фукнционала и не обязателен для работы сценариев.
Сразу пишем модуль, интегрируем его в скрипт который считывает конфиг.
Здесь мало переделок, много параллельной взаимосвязанной работы и видимый результат виден только в конце

### От схемы json

Удобно тем кто уже работал с json-editor
Сразу видишь WEBUI и что важно - видишь генерируемый выходной конфиг который нужно парсить
Быстро можно получить первый PR и сразу имеешь результат в виде константного конфиг файла от которого можно уже строить логику скриптов

1. Модифицируем схему так как нужно для вашего сценария
2. Смотрим то что получается на выходе в конфиге
3. Пробрасываем в скрипт чтение конфига
4. Пишем простой скрипт
5. Выделяем логику инициализации в отдельный модуль

Профит - мы получили то что хотели идя от json схемы с переодическими коммитами и плавным утверждением PR

---
Добавить в секцию definitions новый раздел

Раздел должен иметь уникальное название - в данном случае это `"devicesControl"`
Далее идут стандартные описания раздела - титл и тд
Далее идет раздел properties - этот раздел содержит свойства данного сценария
1) Вначале в любом сценарии должны всегда идти 4 стандартные поля
   - scenarioType
   - enable
   - name
   - id_prefix
2) Далее нужно описать кастомные поля для управления новым сценарием
   Примеры можно посмотреть в готовых сценариях
3) В конце идет `required` которое говорит какие поля должны быть заполнены перед сохранением

```json
        "devicesControl": {
            "type": "object",
            "title": "Light control",
            "description":"Данный сценарий предоставляет возможность управления светом с выключателей <br><img src=\"images/scenarios-link-in-to-out.png\">",
            "_format": "grid",
            "properties": {
                "scenarioType": {
                    "type": "string",
                    "enum": ["devicesControl"],
                    "default": "devicesControl",
                    "options": {
                        "hidden": true
                    }
                },
                "enable": {
                    "type": "boolean",
                    "title": "Enable",
                    "default": true,
                    "_format": "checkbox",
                    "propertyOrder": 1,
                    "options": {
                        "grid_columns": 12
                    }
                },
                "name": {
                    "type": "string",
                    "title": "Scenario name",
                    "default": "Управление светом",
                    "minLength": 1,
                    "maxLength": 30,
                    "propertyOrder": 2,
                    "options": {
                        "grid_columns": 12
                    }
                },
                "id_prefix": {
                    "type": "string",
                    "title": "ID Prefix",
                    "description": "Одно слово на английском языке исключая: пробел, /, +, #. Длина до 15 символов.",
                    "_pattern_comment": "Запрещает пробелы, /, +, и #, а также ограничивает строку использованием только цифр, нижнего подчеркивания и английских букв",
                    "pattern": "^[0-9a-zA-Z_]+$",
                    "default": "light_control",
                    "minLength": 1,
                    "maxLength": 15,
                    "propertyOrder": 3,
                    "options": {
                        "grid_columns": 12
                    }
                },
                ... Тут вставить кастомные поля ...
            },
            "required": ["scenarioType", "enable", "name", "id_prefix"]
        }
```

Добавить сверху

```json
"oneOf": [
    { "$ref": "#/definitions/linkInToOut" },
    { "$ref": "#/definitions/devicesControl" }
],
```

Проверить что все отображается как вы хотите

Сохранить конфиг и посмотреть что все сохранилось конкретно

----

Скрипт 